#!/bin/posix/sh
#
# Sets file permissions in an EPICS directory tree
#
# Time-stamp: <97/02/07 20:39:57 lange>
# $Id: SetPerms,v 1.2 1997/02/11 19:01:41 lange Exp $
#

# Exit if not in .../base or .../extensions or .../csr/capfast (I *love* shell programming)

case `pwd` in
  *CVS/epics | *CVS/epics/base | */CVS/epics/extensions | */CVS/epics/templates)

# Set everything to group epics and ???r-X---

	echo EPICS repository:
	echo Setting everything to group epics and mode ???r-X--- ...
		       
	chgrp -R epics * > /dev/null 2>&1
	chmod -R g=rX,o= * > /dev/null 2>&1

# Set all directories to mode rwxrwxr-x

	echo Setting all directories to mode rwxrwxr-x ...

	chmod u=rwx,g=rwx,o=rx `find . -type d -user $USER`

	;;

  */epics/base* | */epics/extensions* | */epics/local | */csr/capfast)

# Set everything to group epics and ???r-X---

	echo EPICS or CapFast tree:
	echo Setting everything to group epics and mode ???r-X--- ...
		       
	chgrp -R epics * > /dev/null 2>&1
	chmod -R g=rX,o= * > /dev/null 2>&1
		       
# Set all directories and executables to group epima and mode rwxrwxr-x

	echo Setting all directories and executables to group epima and mode rwxrwxr-x ...
		       
	files=`find . -user $USER -and \( -type d -or -type f -perm +111 \)`
	chmod u=rwx,g=rwx,o=rx $files
	chgrp epima $files
	unset files
		       
# Make config files world readable

	if [ -d config ]; then
	  echo Making config, dbd, include and lib files world readable ...
		       
	  chmod -R o+r config dbd include lib lib_sl > /dev/null 2>&1
	fi

# Make binary executables unreadable for others

	echo Making binary executables unreadable for others...
		       
	find . -type f -perm +111 -user $USER \
	 -exec /bin/sh -c "chmod g-w {}; file {} | grep -q executable && chmod o-r {}" \;

	;;
  
  */epics/templates*)

# Set everything to group epics and ???r-Xr-X

	echo EPICS templates tree:
	echo Setting everything to group epics and mode ???r-Xr-X ...
		       
	chgrp -R epics * > /dev/null 2>&1
	chmod -R g=rX,o=rX * > /dev/null 2>&1
		       
# Set all directories and executables to group epima and mode rwxrwxr-x

	echo Setting all directories and executables to group epima and mode rwxrwxr-x ...
		       
	files=`find . -user $USER -and \( -type d -or -type f -perm +111 \)`
	chmod u=rwx,g=rwx,o=rx $files
	chgrp epima $files
	unset files
	;;
  
  */epics/config*)
	   
	echo Setting everything to group epics and mode ???r-X--- ...
			
	chgrp epics * > /dev/null 2>&1
	chmod g=rX,o= * > /dev/null 2>&1

	;;

  *)
	echo Not in EPICS or CapFast Tree.
	exit 1
	;;
esac

exit 0
